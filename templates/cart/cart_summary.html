{% extends "../store/base.html" %}
{% load static %}

{% block title %}: Cart Summary{% endblock %}

{% block main %}
	<div class="container">
    <h1 class="h5">Shopping cart</h1>
    {% for item in cart %}
    {% with product=item.product %}
    <div data-index="{{product.id}}" class="row mb-4 border product-item">
      <div class="col-md-3 col-lg-2 order-md-first bg-light">
        <img class="img-fluid mx-auto d-block" width="120px" alt="Responsive image" src="{{ product.image.url }}">
      </div>
      <div class="col-md-9 col-lg-10 ps-md-3 ps-lg-10">
        <a href="{{ product.get_absolute_url }}" class="text-decoration-none text-reset">
          <h1 class="h5 pt-2">{{ product.title }}</h1>
        </a>
        <div class="border">
          <div class="col border-bottom">
            <div class="row p-3">
              <div class="col-6">{{ product.product_name }}</div>
              <div class="col-6 text-end"><span class="h6 fw-bold">£{{ item.price }}</span></div>
            </div>
          </div>
          <div class="col">
            <div class="row p-3">
              <div class="col-12">
                <label for="select">Qty</label>
                <select class="selectQty" data-index="{{ product.id }}">
                  <option value="1" {% if item.qty == 1 %}selected{% endif %}>1</option>
                  <option value="2" {% if item.qty == 2 %}selected{% endif %}>2</option>
                  <option value="3" {% if item.qty == 3 %}selected{% endif %}>3</option>
                  <option value="4" {% if item.qty == 4 %}selected{% endif %}>4</option>
                </select>
                <button type="button" 
                  		class="btn btn-outline-secondary btn-sm update-button"
                		value="{{ product.id }}"
                >
                  Update
                </button>
                <button type="button" 
                  		class="btn btn-outline-secondary btn-sm delete-button"
                		value="{{product.id}}"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endwith %}
    {% endfor %}
    <div class="col-12 text-end">
      <div class="h6 fw-bold">Sub Total: £<div id="subtotal" class="d-inline-flex">{{cart.total_price}}</div></div>
    </div>
  </div>

  <script type="text/javascript">
  	const cartQty = document.querySelector('#cart-qty')
  	const totalPrice = document.querySelector('#subtotal')
  	const deleteBtns = document.querySelectorAll('.delete-button')
  	const updateBtns = document.querySelectorAll('.update-button')

  	deleteBtns.forEach(btn => {
  		btn.addEventListener('click', e => {
  			fetch('{% url "cart:update_cart" %}', {
  				method: 'DELETE',
  				headers: {
  					'Content-Type': 'application/json',
  					'X-CSRFToken': '{{ csrf_token }}'
  				},
  				body: JSON.stringify({id: btn.value})
  			})
  			.then(res => res.json())
  			.then(data => {
  				if (!data.success) {
  					throw new Error(data.message)
  				}
  				cartQty.innerHTML = data.data.qty
  				totalPrice.innerHTML = data.data.total_price
  				document.querySelector('.product-item[data-index="' + btn.value + '"]').remove()

  			})
  			.catch(error => console.log(error))
  		})
  	})

  	updateBtns.forEach(btn => {
  		btn.addEventListener('click', e => {
        const select = document.querySelector('.selectQty[data-index="' + btn.value + '"]')
  			data = {
  				id: btn.value,
  				qty: parseInt(select.selectedOptions[0].value)
  			}
  			fetch('{% url "cart:update_cart" %}', {
  				method: 'PATCH',
  				headers: {
  					'Content-Type': 'application/json',
  					'X-CSRFToken': '{{ csrf_token }}'
  				},
  				body: JSON.stringify(data)
  			})
  			.then(res => res.json())
  			.then(data => {
  				if (!data.success) {
  					throw new Error(data.message)
  				}
  				cartQty.innerHTML = data.data.qty
  				totalPrice.innerHTML = data.data.total_price
  			})
  			.catch(error => console.log(error))
  		})
  	})

  </script>
{% endblock %}