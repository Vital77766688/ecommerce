{% extends "./base.html" %}
{% load static %}

{% block title %}: {{ category.category_name }}{% endblock %}

{% block main %}
	<h1 class="fw-light">{{ category.category_name }}</h1>

	<div class="album py-5 bg-light">
		<div class="container">
		  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
		    {% for product in products %}
		    <div class="col">
		      <div class="card shadow-sm">
		        <img class="img-fluid" alt="{{ product.product_name }}" src="{{ product.image.url }}" />

		        <div class="card-body">
		 		  <p class="card-text">
		 		  	<a href="{% url 'store:product_details' slug=product.product_slug %}">
		 		  		{{ product.product_name }}
		 		  	</a>
		 		  </p>
		          <small class="card-text">{{ product.description }}</small>
		          <div class="d-flex justify-content-between align-items-center">
		            <div class="btn-group">
		              <button 
		              		type="button" 
		              		class="btn btn-sm btn-outline-secondary add-to-cart"
		              		value="{{ product.id }}"
		              	>
		              	Add to cart
		              </button>
		              <button type="button" class="btn btn-sm btn-outline-secondary">Buy now</button>
		            </div>
		            <small class="text-muted">${{ product.price }}</small>
		          </div>
		        </div>
		      </div>
		    </div>
		    {% endfor %}
		  </div>
		</div>
  </div>

  <script type="text/javascript">
  	const addToCartBtns = document.querySelectorAll('.add-to-cart')
  	addToCartBtns.forEach(btn => {
  		btn.addEventListener('click', e => {
  			e.preventDefault()
		  	data = {
		  		productId: btn.value,
		  		qty: 1,
		  	}
		  	console.log(data)
		  	fetch('{% url "cart:update_cart" %}', {
		  		method: 'POST',
		  		headers: {
		  			'Content-Type': 'application/json',
		  			'X-CSRFToken': '{{ csrf_token }}'
		  		},
		  		body: JSON.stringify(data),
		  	})
		  	.then(res => res.json())
		  	.then(data => {
		  		if (!data.success) {
		  			throw new Error(data.message)
		  		}
		  		const cartQty = document.querySelector('#cart-qty')
		  		cartQty.innerHTML = data.data.qty
		  	})
		  	.catch(error => console.log(error))
  		})
  	})
  </script>
{% endblock %}